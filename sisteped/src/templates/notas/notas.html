{% extends "base.html" %}

{% block content %}
<div class="page-container">
    <header class="page-header">
        <h2>Histórico de Notas</h2>
    </header>

    <div class="toolbar">
        <form action="{{ url_for('notas.index') }}" method="GET" style="display: flex; width: 100%; gap: 12px; align-items: center;">
            <div class="toolbar-left" style="display: flex; flex: 1; gap: 12px;">
                <div class="search-box" style="position: relative; display: flex; align-items: center;">
                    <button type="submit" style="background: none; border: none; padding: 0; cursor: pointer; display: flex; align-items: center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                    <input type="text" name="busca" placeholder="Buscar aluno..." value="{{ busca_atual or '' }}" id="inputBusca" style="padding-right: 30px;">
                    
                    {% if busca_atual %}
                    <a href="{{ url_for('notas.index') }}" style="position: absolute; right: 10px; color: #9ca3af; text-decoration: none; font-size: 18px;">&times;</a>
                    {% endif %}
                </div>

                <a href="{{ url_for('notas.cadastrar_notas') }}">
                    <button type="button" class="btn-black small">Lançar Novas</button>
                </a>
            </div>
        </form>
    </div>

    <div class="table-responsive">
        <table class="clean-table">
            <thead>
                <tr>
                    <th style="width: 35%;">Aluno</th>
                    <th>Turma</th>
                    <th>Disciplina</th>
                    <th>Nota</th> 
                    <th class="text-gray">Data</th>
                    <th class="text-right">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% if notas %}
                    {% for nota in notas %}
                    <tr>
                        <td>
                            <div class="student-cell">
                                <strong>{{ nota.nome_aluno }}</strong>
                                <span>{{ nota.atividade }}</span>
                            </div>
                        </td>
                        <td><span class="badge">{{ nota.nome_turma }}</span></td>
                        <td><span class="badge secondary">{{ nota.disciplina }}</span></td>
                        <td>
                            <strong class="grade-text {{ 'positive' if nota.nota|float >= 6 else 'negative' }}">
                                {{ "%.2f"|format(nota.nota|float) }}
                            </strong>
                        </td>
                        <td class="text-gray">{{ nota.data.strftime('%d/%m/%Y') if nota.data else '-' }}</td>
                        <td class="text-right">
                            <button class="icon-btn-edit" onclick="abrirModalEdicao('{{ nota.idAvaliacao }}', '{{ nota.nome_aluno }}', '{{ nota.nota }}')">&#9998;</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="6" class="text-center text-gray" style="padding: 40px;">Nenhum registro encontrado.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if total_paginas > 1 %}
    <div class="pagination-wrapper" style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #e5e7eb;">
        <div style="color: #6b7280; font-size: 0.9rem;">Página <strong>{{ pagina_atual }}</strong> de {{ total_paginas }}</div>
        <div style="display: flex; gap: 8px;">
            {% if pagina_atual > 1 %}
                <a href="{{ url_for('notas.index', pagina=pagina_atual-1, busca=busca_atual) }}" class="btn-pagination">Anterior</a>
            {% endif %}

            {% for p in range(1, total_paginas + 1) %}
                {% if p == pagina_atual %}
                    <span class="btn-pagination active">{{ p }}</span>
                {% elif p <= 3 or p > total_paginas - 2 or (p >= pagina_atual - 1 and p <= pagina_atual + 1) %}
                    <a href="{{ url_for('notas.index', pagina=p, busca=busca_atual) }}" class="btn-pagination">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if pagina_atual < total_paginas %}
                <a href="{{ url_for('notas.index', pagina=pagina_atual+1, busca=busca_atual) }}" class="btn-pagination">Próxima</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<style>
    .btn-pagination { padding: 6px 14px; border: 1px solid #e5e7eb; border-radius: 6px; text-decoration: none; color: #374151; font-size: 0.85rem; }
    .btn-pagination.active { background: #111827; color: #fff; border-color: #111827; }
    .btn-pagination:hover:not(.active) { background: #f9fafb; }
</style>


<div id="modalNota" class="modal-overlay">
    <div class="modal-content">
        <header style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <h3 class="section-title" style="margin:0">Editar Registro</h3>
            <button onclick="fecharModal()" style="background:none; border:none; font-size:20px; cursor:pointer">&times;</button>
        </header>

        <form id="formEditarNota" method="POST">
            <div class="modal-body">
                <p class="subtitle">Aluno: <strong id="nomeAlunoModal"></strong></p>
                <div class="form-group" style="margin-top:15px">
                    <label class="form-label">Nota</label>
                    <input type="number" name="nova_nota" id="inputNotaModal" step="0.1" min="0" max="10" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn-black flex-2">Salvar Alteração</button>
                <button type="button" id="btnExcluirNota" class="btn-danger-outline flex-1">Apagar</button>
            </div>

            <input type="hidden" name="pagina_atual" value="{{ pagina_atual }}">
            <input type="hidden" name="busca_atual" value="{{ busca_atual }}">
        </form>
    </div>
</div>

<div id="modalConfirmacao" class="modal-overlay danger">
    <div class="modal-content small">
        <h3 class="text-red">Tem certeza?</h3>
        <p class="text-gray" style="margin: 15px 0">Esta nota será removida permanentemente do banco de dados.</p>
        <div class="modal-footer" style="justify-content: center">
            <button onclick="fecharConfirmacao()" class="btn-secondary">Cancelar</button>
            <button id="btnConfirmarExclusaoFinal" class="btn-danger-confirm">Sim, Apagar</button>
        </div>
    </div>
</div>


<script>
    let idNotaAtual = null;

    function abrirModalEdicao(id, nome, nota) {
        idNotaAtual = id;
        document.getElementById('nomeAlunoModal').innerText = nome;
        document.getElementById('inputNotaModal').value = parseFloat(nota).toFixed(1);

        // 1. Pegar os parâmetros atuais da URL (página e busca)
        const urlParams = new URLSearchParams(window.location.search);
        const pagina = urlParams.get('pagina') || 1;
        const busca = urlParams.get('busca') || '';

        // 2. Definir o action com a rota + os parâmetros de estado
        const actionUrl = `/notas/atualizar_individual/${id}?pagina=${pagina}&busca=${encodeURIComponent(busca)}`;
        document.getElementById('formEditarNota').action = actionUrl;

        document.getElementById('modalNota').style.display = 'flex';
    }

    function fecharModal() { document.getElementById('modalNota').style.display = 'none'; }

    function abrirConfirmacao() {
        document.getElementById('modalConfirmacao').style.display = 'flex';
        
        // Pegar os valores da URL atual para não perdê-los ao deletar
        const urlParams = new URLSearchParams(window.location.search);
        const pag = urlParams.get('pagina') || 1;
        const bus = urlParams.get('busca') || '';

        document.getElementById('btnConfirmarExclusaoFinal').onclick = function() {
            // Envia os parâmetros na URL para a rota de exclusão
            window.location.href = `/notas/excluir_individual/${idNotaAtual}?pagina=${pag}&busca=${bus}`;
        };
    }

    function fecharConfirmacao() { 
        document.getElementById('modalConfirmacao').style.display = 'none';
    }

    document.getElementById('btnExcluirNota').onclick = (e) => {
        e.preventDefault();
        abrirConfirmacao();
    };

    window.onclick = (event) => {
        if (event.target == document.getElementById('modalNota')) fecharModal();
        if (event.target == document.getElementById('modalConfirmacao')) fecharConfirmacao();
    }

    // Função de busca simples para o campo de pesquisa
    function filtrarTabela() {
        let input = document.getElementById("inputBusca").value.toUpperCase();
        let tr = document.getElementById("tabelaNotas").getElementsByTagName("tr");
        for (let i = 1; i < tr.length; i++) {
            let td = tr[i].getElementsByTagName("td")[0];
            if (td) {
                let txtValue = td.textContent || td.innerText;
                tr[i].style.display = txtValue.toUpperCase().indexOf(input) > -1 ? "" : "none";
            }
        }
    }
</script>
{% endblock %}