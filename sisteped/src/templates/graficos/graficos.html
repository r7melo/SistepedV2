{% extends "base.html" %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>Análise de Desempenho e Clima</h2>
        
    </div>

    <div class="dashboard-controls-wrapper">
        <div class="class-selector-container">
            <label class="form-label">Selecionar Turma para Análise</label>
            <select id="select-turma" class="form-control" onchange="carregarTodosGraficos()">
                <option value="" disabled selected>Escolha uma turma...</option>
                {% for t in turmas %}
                    <option value="{{ t.idTurma }}">{{ t.nome }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div id="dashboard-content" style="display: none; animation: fadeIn 0.4s ease-out;">
        
        <div class="dashboard-card full-width">
            <h3>Evolução das Notas ao Longo do Tempo</h3>
            <div class="chart-container" style="height: 350px;">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>Médias por Disciplina</h3>
                <div class="chart-container" style="height: 320px;">
                    <canvas id="subjectChart"></canvas>
                </div>
            </div>

            <div class="dashboard-card">
                <h3>Clima Comportamental (Frequência)</h3>
                <div class="chart-container" style="height: 320px;">
                    <canvas id="behaviorRadarChart"></canvas>
                </div>
            </div>
        </div>

        <div class="dashboard-card full-width">
            <h3>Distribuição de Performance (Quantidade de Alunos)</h3>
            <div class="chart-container" style="height: 250px;">
                <canvas id="distributionBarChart"></canvas>
            </div>
        </div>
    </div>

    <div id="dashboard-placeholder" class="dashboard-card" style="text-align: center; padding: 60px;">
        <svg width="48" height="48" fill="none" stroke="#9ca3af" stroke-width="2" viewBox="0 0 24 24" style="margin-bottom: 15px;">
            <path d="M3 3v18h18M7 16l4-4 4 4 5-5"></path>
        </svg>
        <p style="color: #6b7280; font-size: 1rem;">Selecione uma turma no menu acima para carregar as estatísticas.</p>
    </div>
</div>

<style>
/* Dashboard Estilo */
.dashboard-controls-wrapper { 
    background: #fff; 
    padding: 24px; 
    border-radius: 12px; 
    border: 1px solid #e5e7eb; 
    margin-bottom: 25px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.class-selector-container { max-width: 400px; }

.dashboard-card { 
    background: #fff; 
    border: 1px solid #e5e7eb; 
    border-radius: 16px; 
    padding: 24px; 
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
}

.dashboard-card h3 { 
    font-size: 0.9rem; 
    font-weight: 600; 
    color: #374151; 
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.dashboard-card h3::before {
    content: '';
    display: inline-block;
    width: 4px;
    height: 16px;
    background: #000;
    border-radius: 4px;
}

.dashboard-grid { 
    display: grid; 
    grid-template-columns: 1.2fr 0.8fr; 
    gap: 24px; 
}

.chart-container { position: relative; width: 100%; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 1024px) { 
    .dashboard-grid { grid-template-columns: 1fr; } 
}

canvas { max-width: 100% !important; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let charts = {};

    // Opções Padrão Globais para os gráficos ficarem "limpos"
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: { grid: { color: '#f3f4f6', drawBorder: false }, ticks: { color: '#9ca3af' } },
            x: { grid: { display: false }, ticks: { color: '#4b5563' } }
        }
    };

    async function carregarTodosGraficos() {
        const turmaId = document.getElementById('select-turma').value;
        if (!turmaId) return;

        document.getElementById('dashboard-placeholder').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';

        // 1. Comportamento
        fetch(`/graficos/api/comportamento/${turmaId}`).then(r => r.json()).then(renderRadar);
        // 2. Timeline
        fetch(`/graficos/api/timeline/${turmaId}`).then(r => r.json()).then(renderTimeline);
        // 3. Disciplinas
        fetch(`/graficos/api/disciplinas/${turmaId}`).then(r => r.json()).then(renderSubjects);
        // 4. Distribuição
        fetch(`/graficos/api/distribuicao/${turmaId}`).then(r => r.json()).then(renderDistribution);
    }

    function renderRadar(dados) {
        if (charts.radar) charts.radar.destroy();
        charts.radar = new Chart(document.getElementById('behaviorRadarChart'), {
            type: 'radar',
            data: {
                labels: dados.map(d => d.tag),
                datasets: [{
                    data: dados.map(d => d.total),
                    backgroundColor: 'rgba(0,0,0,0.05)',
                    borderColor: '#000',
                    borderWidth: 2,
                    pointBackgroundColor: '#000'
                }]
            },
            options: { ...commonOptions, scales: { r: { ticks: { display: false }, grid: { color: '#e5e7eb' } } } }
        });
    }

    function renderTimeline(dados) {
        if (charts.line) charts.line.destroy();
        charts.line = new Chart(document.getElementById('timelineChart'), {
            type: 'line',
            data: {
                labels: dados.map(d => d.mes),
                datasets: [{ 
                    label: 'Média', 
                    data: dados.map(d => d.media), 
                    borderColor: '#000', 
                    backgroundColor: 'rgba(0,0,0,0.02)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3
                }]
            },
            options: { ...commonOptions, plugins: { legend: { display: true, position: 'top', align: 'end' } } }
        });
    }

    function renderSubjects(dados) {
    
        if (charts.bar) charts.bar.destroy();
        
        const ctx = document.getElementById('subjectChart').getContext('2d');
        
        charts.bar = new Chart(ctx, {
            type: 'bar',
            data: {
                
                labels: dados.map(d => d.disciplina), 
                datasets: [{
                    label: 'Média da Turma',
                    data: dados.map(d => d.media), 
                    backgroundColor: '#111827',
                    borderRadius: 4,
                    barPercentage: 0.6
                }]
            },
            options: {
                indexAxis: 'y', 
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        beginAtZero: true, 
                        max: 10,
                        grid: { color: '#f3f4f6' },
                        ticks: { color: '#9ca3af' }
                    },
                    y: { 
                        grid: { display: false },
                        ticks: { 
                            color: '#111827',
                            font: { weight: '600', size: 12 }
                        }
                    }
                }
            }
        });
    }

    function renderDistribution(dados) {
        if (charts.dist) charts.dist.destroy();
        charts.dist = new Chart(document.getElementById('distributionBarChart'), {
            type: 'bar',
            data: {
                labels: ['0-3', '3-5', '5-7', '7-9', '9-10'],
                datasets: [{
                    data: dados,
                    backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#059669'],
                    borderRadius: 8,
                    barPercentage: 0.6
                }]
            },
            options: commonOptions
        });
    }

    
</script>
{% endblock %}